<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>K8s 入门学习笔记 | Vianlex&#39;s Wiki</title>
    
    
        <meta name="keywords" content="K8s 入门学习笔记" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="1. 介绍Kubernetes 的简称 K8s，Kubernetes 是 Google 开源的容器编排工具。kubernetes 的本质是一组服务器集群，集群的每个节点上运行特定的程序组件，通过组件去实现资源管理的自动化。 2. K8s 组件一个 K8s 集群主要是由控制节点（Master node）、工作节点（Work node）构成，每个节点上都会安装不同的组件, 如下图所所示(图片来源于网络">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s 入门学习笔记">
<meta property="og:url" content="http://example.com/wiki/Kubernetes/K8s%20%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Vianlex&#39;s Wiki">
<meta property="og:description" content="1. 介绍Kubernetes 的简称 K8s，Kubernetes 是 Google 开源的容器编排工具。kubernetes 的本质是一组服务器集群，集群的每个节点上运行特定的程序组件，通过组件去实现资源管理的自动化。 2. K8s 组件一个 K8s 集群主要是由控制节点（Master node）、工作节点（Work node）构成，每个节点上都会安装不同的组件, 如下图所所示(图片来源于网络">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/k8s-%E6%9E%B6%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="http://example.com/images/%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7%E4%BA%8B%E4%BB%B6.png">
<meta property="og:image" content="http://example.com/images/Ingress-%E7%BD%91%E7%BB%9C.png">
<meta property="article:published_time" content="2023-05-31T13:39:26.110Z">
<meta property="article:modified_time" content="2023-05-31T13:39:26.110Z">
<meta property="article:author" content="Vianlex">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/k8s-%E6%9E%B6%E6%9E%84%E5%9B%BE.png">
    

    

    
        <link rel="icon" href="/favicon.ico" />
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Vianlex's Wiki" type="application/atom+xml">
</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Vianlex&#39;s Wiki</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id='categories'>
        <h3 class="widget-title">
            <span>分类目录</span>
            &nbsp;
            <a id='allExpand' href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Apache POI
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Apache%20POI/Excel%20%E8%AE%BE%E7%BD%AE%E8%A1%8C%E9%AB%98%E5%92%8C%E6%8D%A2%E8%A1%8C%E9%97%AE%E9%A2%98/">Excel 设置行高和换行问题</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Docker
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Docker/Docker%20Swarm%20%E7%AC%94%E8%AE%B0/">Docker Swarm 笔记</a></li>  <li class="file"><a href="/wiki/Docker/Docker%20%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">Docker 入门笔记</a></li>  <li class="file"><a href="/wiki/Docker/Docker%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Docker 常用命令</a></li>  <li class="file"><a href="/wiki/Docker/Docker%20%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/">Docker 权限配置</a></li>  <li class="file"><a href="/wiki/Docker/Dockerfile%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">Dockerfile 使用说明</a></li>  <li class="file"><a href="/wiki/Docker/docker%20%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/">Docker 安装笔记</a></li>  <li class="file"><a href="/wiki/Docker/docker-compose%20%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">Docker-compose 学习记录</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Golang
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Golang/Go%20%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Go 基础语法</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Java 知识点
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/Class%E5%AF%B9%E8%B1%A1%E5%92%8CTpye%E5%AF%B9%E8%B1%A1/">Class 对象和 Tpye 对象知识笔记</a></li>  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/Instrumentation%20%E7%9F%A5%E8%AF%86%E7%AC%94%E8%AE%B0/">Instrumentation 知识笔记</a></li>  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/Java%20main%20%E5%92%8C%20classpath/">main 方法和 classpath 说明</a></li>  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/Javassist%20%E7%9F%A5%E8%AF%86%E7%AC%94%E8%AE%B0/">Javassist 知识笔记</a></li>  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/SecurityManager%20%E7%AC%94%E8%AE%B0/">SecurityManager 笔记</a></li>  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/byteBuddy%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">ByteBuddy 入门笔记</a></li>  <li class="file"><a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/Drools%E7%AC%94%E8%AE%B0/">Drools 笔记</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Java 设计模式
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Java%20%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">代理模式</a></li>  <li class="file"><a href="/wiki/Java%20%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/">工厂模式</a></li>  <li class="file"><a href="/wiki/Java%20%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F/">模板模式(模板方法模式)</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Jemeter
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Jemeter/Jemeter%20%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">Jemeter 入门笔记</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Kubernetes
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Kubernetes/kubeadm%20%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%20k8s%20%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83/">kubeadm 快速部署 kubernetes 集群测试环境</a></li>  <li class="file"><a href="/wiki/Kubernetes/kubeadm%E5%AE%89%E8%A3%85%20k8s%20%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">kubeadm安装 k8s 问题记录</a></li>  <li class="file active"><a href="/wiki/Kubernetes/K8s%20%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">K8s 入门学习笔记</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Linux
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Linux/SSH%20%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E5%92%8C%E5%AF%86%E9%92%A5%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/">SSH 密码登录和密钥配置说明</a></li>  <li class="file"><a href="/wiki/Linux/ECS%20%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E7%9B%98/">ECS 云服务器挂载数据盘</a></li>  <li class="file"><a href="/wiki/Linux/Linux%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8C%82%E8%BD%BD%E7%A1%AC%E7%9B%98/"></a></li>  <li class="file"><a href="/wiki/Linux/SSH%20%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/">SSH 端口转发用法说明</a></li>  <li class="file"><a href="/wiki/Linux/dnf%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/">dnf 软件包管理工具</a></li>  <li class="file"><a href="/wiki/Linux/iptables%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">iptables 学习笔记</a></li>  <li class="file"><a href="/wiki/Linux/yum%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">YUM 常用命令</a></li>  <li class="file"><a href="/wiki/Linux/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95/">Linux 常用命令记录</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Maven
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Maven/Maven%20%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">Maven 问题记录</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            MySql
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/MySql/MySql%20%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0/">MySql 常用函数</a></li>  <li class="file"><a href="/wiki/MySql/MySql%20%E5%BC%80%E7%AA%97%E5%87%BD%E6%95%B0/">MySql 开窗函数</a></li>  <li class="file"><a href="/wiki/MySql/Mysql%20%E9%83%A8%E5%88%86%E8%AF%8D%E6%B1%87%E5%90%AB%E4%B9%89/">Mysql 部分词汇含义</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Nginx
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Nginx/Nginx%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Nginx 常用命令</a></li>  <li class="file"><a href="/wiki/Nginx/Tengine%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/"></a></li>  <li class="file"><a href="/wiki/Nginx/location%20%E6%8C%87%E4%BB%A4%E7%AC%94%E8%AE%B0/">location 和 rewrite 笔记</a></li>  <li class="file"><a href="/wiki/Nginx/ngx_http_proxy_module%E6%A8%A1%E5%9D%97%E7%AC%94%E8%AE%B0/">ngx_http_proxy_module 模块学习笔记</a></li>  <li class="file"><a href="/wiki/Nginx/ngx_http_rewrite_module%20%E6%A8%A1%E5%9D%97%E7%AC%94%E8%AE%B0/">ngx_http_rewrite_module 模块学习笔记</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            NodeJs
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/NodeJs/Node%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/">Node 环境配置说明</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            PowerDesigner
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/PowerDesigner/%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">使用出现问题记录</a></li>  <li class="file"><a href="/wiki/PowerDesigner/%E9%80%86%E5%90%91%E5%AF%BC%E5%85%A5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">SQL 逆向导入生成 PDM</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Redis
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Redis/Redis%20%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E9%9B%AA%E5%B4%A9/">Redis 缓存穿透、缓存击穿、缓存雪崩</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Shell
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Shell/Awk%20%20%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95/">Awk 基础用法</a></li>  <li class="file"><a href="/wiki/Shell/Sed%20%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95/">Sed 基础用法</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            SpringBoot
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/SpringBoot/SpringBoot%20%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE/">SpringBoot 属性配置</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Xml
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/Xml/Dom4j%20%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">Dom4j 入门笔记</a></li>  <li class="file"><a href="/wiki/Xml/XPath%20%E7%AC%94%E8%AE%B0/">XPath 笔记</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            other
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/other/%E8%BD%AF%E4%BB%B6%E5%90%8D%E7%A7%B0%E8%AE%B0%E5%BD%95/">软件名称记录</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            计算机网络
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">网络设备入门笔记</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/wiki/index/"></a></li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-Kubernetes/K8s 入门学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Kubernetes/">Kubernetes</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/Kubernetes/K8s%20%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
            <time datetime="2023-05-31T13:39:26.110Z" itemprop="datePublished">2023-05-31</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="noopener" href='https://github.com/Vianlex/blog/raw/gh-pages/source/_posts/Kubernetes/K8s 入门学习笔记.md'> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="noopener" href='https://github.com/Vianlex/blog/edit/gh-pages/source/_posts/Kubernetes/K8s 入门学习笔记.md'> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="noopener" href='https://github.com/Vianlex/blog/commits/gh-pages/source/_posts/Kubernetes/K8s 入门学习笔记.md'> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            K8s 入门学习笔记
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><p>Kubernetes 的简称 K8s，Kubernetes 是 Google 开源的容器编排工具。kubernetes 的本质是一组服务器集群，集群的每个节点上运行特定的程序组件，通过组件去实现资源管理的自动化。</p>
<h2 id="2-K8s-组件"><a href="#2-K8s-组件" class="headerlink" title="2. K8s 组件"></a>2. K8s 组件</h2><p>一个 K8s 集群主要是由控制节点（Master node）、工作节点（Work node）构成，每个节点上都会安装不同的组件, 如下图所所示(图片来源于网络)：<br><img src="/images/k8s-%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="图一"></p>
<h3 id="2-1-Master-节点"><a href="#2-1-Master-节点" class="headerlink" title="2.1 Master 节点"></a>2.1 Master 节点</h3><p>Mater 节点负载整个集群的管理和和控制、以及负责集群的决策。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>apiserver</td>
<td>提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制</td>
</tr>
<tr>
<td>controller-manager</td>
<td>负责维护集群的状态，比如故障检测、自动扩展、滚动更新等</td>
</tr>
<tr>
<td>scheduler</td>
<td>负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上</td>
</tr>
<tr>
<td>etcd</td>
<td>保存了整个集群的状态（集群中各种资源对象的信息）</td>
</tr>
</tbody></table>
<h3 id="2-2-Node-节点"><a href="#2-2-Node-节点" class="headerlink" title="2.2 Node 节点"></a>2.2 Node 节点</h3><p>Node 真正运行工作负载的节点，通过 kube-proxy 管理应用服务的访问入口，包括集群内 pod 到 service 的访问，以及集群外访问 service。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Kubelet</td>
<td>负责维护容器的生命周期，即通过控制 docker、来创建、更新、销毁容器</td>
</tr>
<tr>
<td>Kube-Proxy</td>
<td>负责提供 Node 节点应用集群的服务发现和负载均衡，Internet(或者用户)访问应用前必须经过 Kube-Proxy</td>
</tr>
<tr>
<td>docker</td>
<td>负责镜像管理以及Pod和提供容器的真正运行接口(CRI) , CRI 是一个接口，用来操作容器的接口。k8s通过CRI对容器进行操作，创建、启停容器等</td>
</tr>
</tbody></table>
<h3 id="2-3-kubectl"><a href="#2-3-kubectl" class="headerlink" title="2.3 kubectl"></a>2.3 kubectl</h3><p>kubectl 是与 kubernetes 集群交互的一个命令行工具，kubectl 通过与 kubernets api server 提供 Rest API 来操作控制 K8s 集群，类似于 docker 中的 docker 命令。kubectl 在执行命令的时候可以加上一个 -v&#x3D;9 参数（注意参数值越大日志越详细）查看执行的具体步骤：</p>
<ul>
<li>读取 kubectl 的配置文件，判断需要与哪个 api server 交互</li>
<li>生成 request body</li>
<li>调用 API</li>
<li>输出结果</li>
</ul>
<h4 id="2-3-1-kubectl-的语法"><a href="#2-3-1-kubectl-的语法" class="headerlink" title="2.3.1 kubectl 的语法"></a>2.3.1 kubectl 的语法</h4><p>kubectl 的命令行语法格式 <code> kubectl [command] [resource-type] [name] [flags]</code></p>
<ul>
<li>command 指定对资源执行的操作，如：create、apply、get、describe、delete 等</li>
<li>resource-type 指定要操作的资源类型，使用资源的单数或者复数、简写都可以，如 pods 或 pod 或 po, nodes 或 node 或 no, 等等</li>
<li>name 根据名称指定要操作的具体资源</li>
<li>flags</li>
</ul>
<h2 id="3-K8s-resouce-资源-的理解"><a href="#3-K8s-resouce-资源-的理解" class="headerlink" title="3. K8s resouce(资源)的理解"></a>3. K8s resouce(资源)的理解</h2><p>K8s 组件是支持 K8s 平台运行的软件，是系统运行的进程，资源是通过组件去创建和管理的。跟 Linux 中一切皆文件, 在 K8S 中也有一切皆资源的概念。Resource 是 K8s 的一个基础概念，k8s 用 Resource 来表示集群中的各个资源。d都可以在资源文件中配置。比如 Pod、Service、Deployment、namespace 等等都属于 K8s 的资源，尽管这个资源看起来差别很大，但它们都有许多共同的属性，如 name(名称)、kind(类型)、apiVersion(api版本)、metadata(元信息等)。</p>
<h3 id="3-1-查看-resource-资源-的命令"><a href="#3-1-查看-resource-资源-的命令" class="headerlink" title="3.1 查看 resource(资源)的命令"></a>3.1 查看 resource(资源)的命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resource </span><br></pre></td></tr></table></figure>
<h3 id="3-2-resource-资源-文件定义"><a href="#3-2-resource-资源-文件定义" class="headerlink" title="3.2 resource(资源)文件定义"></a>3.2 resource(资源)文件定义</h3><p>k8s 资源支持定义的属性很多，定义资源文件时，未定义的属性 k8s 会设置有默认值，k8s 支持通过 YAML 和 JSON 格式文件定义资源对象，使用命令 <code>kebectl explain [ resource | resource.attribe ]</code> 资源能定义哪些属性，使用 YAML 定义资源的格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定资源的版本，命令 kubectl explain resource 可以查看资源使用的版本，如查看 pod 资源的版本，运行命令： kubectl explain pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="comment"># 指定资源的类型，pod、namespace, service 等等</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">pod</span></span><br><span class="line"><span class="comment"># metadata 可以定义的资源的名称等，可以使用命令 kubectl explain resource.metadata 查看支持哪些属性的定义  </span></span><br><span class="line"><span class="attr">metadata:</span>   </span><br><span class="line">  <span class="comment"># 指定资源的名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">  <span class="comment"># 指定资源的命名空间，指定的话，默认是 default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="comment"># 指定资源的版本</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;11012&quot;</span></span><br><span class="line"><span class="comment"># 定义资源的特定属性</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="comment"># 使用命令 kubectl explain resource.</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="comment"># 指定容器的名称</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span> </span><br><span class="line">      <span class="comment"># 指定容器运行的镜像</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="comment"># hostport(主机端口) 和 containerPort(容器端口) 相当于 docker run -p 指定的端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">hostport:</span> <span class="number">80</span>  </span><br></pre></td></tr></table></figure>
<p>快速生成资源文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不存在的资源，需要指定 --dry-run 表示不是正在的创建资源，只是试运行，为了导出资源文件 </span></span><br><span class="line">kubectl create deployment web --image=nginx-o yaml --dry-run</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">kubectl run Pod test-nginx --image=nginx --dry-run=client -o yaml</span><br><span class="line"><span class="comment"># 根据存在的资源导出资源文件</span></span><br><span class="line">kubectl get pods [pod-name] -o yaml</span><br></pre></td></tr></table></figure>

<h3 id="3-3-资源的命名空间"><a href="#3-3-资源的命名空间" class="headerlink" title="3.3 资源的命名空间"></a>3.3 资源的命名空间</h3><p>命名空间为集群中的资源名称赋予作用域，主要作用是资源名称隔离，在命名空间中资源名称必须是唯一的，但是并不是所有的资源都使用命名空间隔离的名称，具体可以使用命令 <code>kubectl api-resource</code> 查看。<br>创建命名空间使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一种方式创建命名空间，查看创建日志，在命令后面加参数 -v = 9 其中 9 表示日志的级别，一般数字越大信息越详细</span></span><br><span class="line">kubectl create [ns | namespaces]  空间名称  </span><br><span class="line"><span class="comment"># 第二种方式，第一中方式其实时第二种方式的简化处理</span></span><br><span class="line">kubectl create -f /xx/xx/xx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看命名空间信息，可选参数 -o 指定查看信息的详细程度和输出格式</span></span><br><span class="line">kubectl get [ns | namespaces] 空间名称 -o [wide | ymal | json ] </span><br><span class="line"><span class="comment"># 删除命名空间</span></span><br><span class="line">kubectl delete [ns | namespaces]  空间名称</span><br></pre></td></tr></table></figure>
<h3 id="3-4-操作-resouce-资源-的常用命令"><a href="#3-4-操作-resouce-资源-的常用命令" class="headerlink" title="3.4 操作 resouce(资源)的常用命令"></a>3.4 操作 resouce(资源)的常用命令</h3><p>需要命名空间隔离的资源，使用 kubectl 操作时，都是需要指定命名空间的，如果不指定命名空间，则默认操作的是 default 命名空间下的资源。使用命令 <code>kubectl api-resources </code> 查看哪些资源是需要命名空间隔离的。</p>
<ol>
<li>kubectl create 命令，用于创建 k8s 资源，常用可选参数：</li>
</ol>
<ul>
<li>f 指定创建资源使用的资源文件或者流<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意需要命名空间隔离的资源，如果没有指定命名空间的会默认将资源创建在 default 命令空间中</span></span><br><span class="line">kubectl create -f resource-file.yaml 或 resource-file.josn 或 http://xxx/xx/xx.yaml</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li>kubectl apply 命令，用于更新资源，不存在则创建新的资源，常用的可选参数</li>
</ol>
<ul>
<li>-f 指定创建资源使用的资源文件或者文件流</li>
<li>-k 指定使用某个目录下的 kustomization.yaml 文件创建或者更新资源</li>
<li>–record 将当前执行的命令，记录在资源的annotation(注释)中，记录的格式为 <code> kubernetes.io/change-cause: &lt;kubectl 执行的命令&gt;</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据指定的资源文件更新或者创建资源</span></span><br><span class="line">kubectl apply -f  resource-file.yml 或 resouce-file.json 或 https://xxx/xxx/resource-file.yml</span><br><span class="line"><span class="comment"># 根据资源文件的标准输入流创建或者更新资源</span></span><br><span class="line"><span class="built_in">cat</span> resource-file.yml |  kubectl apply -f - </span><br><span class="line"><span class="comment"># 指定读取目录下的资源文件</span></span><br><span class="line">kubectl apply -k  /home/resource-dir</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>kubectl get 命令查看资源信息，常用参数</li>
</ol>
<ul>
<li>-A 指定查看全部命名空间的资源</li>
<li>-n 指定查看某个命名空间的资源，如 <code>-n kube-system </code></li>
<li>–show-lables 查看资源的 label </li>
<li>-w, –watch&#x3D;&lt;true|false&gt; 实时显示资源信息，相当于 tail 中的 -f </li>
<li>-o, –output 指定结果的输出格式，常用的可选值有 wide、yaml、json、name(只显示名称) 等等<br>注意查看资源时，如果时需要命名空间隔离的资源，需要 <code>-n </code> 参数指定命名空间或者 <code>-A</code> 指定查看全部命名空间的资源，如果指定命名空间，默认查看的是 default 命名空间的资源，可以使用命令 <code>kubectl api-resources</code> 查看资源是否需要命名空间隔离。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 k8s 的所有 node 节点</span></span><br><span class="line">kubectl get nodes </span><br><span class="line"><span class="comment"># 根据名字查看某个 node 节点</span></span><br><span class="line">kubectl get node [node-name] </span><br><span class="line"><span class="comment"># 查看 pod 资源</span></span><br><span class="line">kubectl get pods <span class="comment"># 不指定命名空间，查看的 default 命名空间的所有 pod </span></span><br><span class="line"><span class="comment"># 查看所有命名空间下的所有 pod</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"><span class="comment"># 查看某个命名空间的所有 pod</span></span><br><span class="line">kubectl get pods kube-system</span><br><span class="line"><span class="comment"># 根据名称查看某个 pod </span></span><br><span class="line">kubectl get pod [pod-name] -o wide | yaml | josn </span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>kubectl describe 命令展示资源详情信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod 的详情信息和 Pod 容器事件 Events</span></span><br><span class="line">kubectl describe pod [pod-name] [-n 命名空间]</span><br><span class="line"><span class="comment"># 查看 node 节点的详细信息和节点的内存和 cpu 信息，以及 Pod 限制 cpu 和内存信息</span></span><br><span class="line">kubectl describe node [node-name]</span><br></pre></td></tr></table></figure></li>
<li>kubectl label 命令，用于新增、更新、删除资源标签，资源的每个标签都是 <code>key=value</code> 的形式，注意在 yaml 中定义资源的标签时，使用的是<code>key : value</code> 形式<br>命令的语法格式 <code>kubectl lable &lt;resource-type : resource-file &gt; &lt;resouece-name&gt;... &lt;key=label&gt;... [--resource-version=version]</code> 其中 … 表示可以指定多个然后用空格隔开 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 node 节点标签</span></span><br><span class="line">kubectl get nodes --show-labels</span><br><span class="line"><span class="comment"># 给名为 k8s-node01 的 node 节点打上 hello=world 标签</span></span><br><span class="line">kubectl label node k8s-node  hello=world</span><br><span class="line"><span class="comment"># --overwrite 表示打标签时，如果存在标签 key 相同的标签，则覆盖更新标签</span></span><br><span class="line">kubectl label node k8s-node --overwrite hello=node-world</span><br><span class="line"><span class="comment"># 给所有node 节点都打上 test-k8s-node = true 标签</span></span><br><span class="line">kubectl label node --all  test-k8s-node = <span class="literal">true</span> </span><br><span class="line"><span class="comment"># 给名为 k8s-node01 和 k8s-node02 的节点都打上 hello=world 和 whoiam=node 标签</span></span><br><span class="line">kubectl label node k8s-node01 k8s-node02 hello=world whoiam=node</span><br><span class="line"><span class="comment"># 删除资源的标签，使用 key和减号，如删除所有节点中标签 key 等于 hello 的标签</span></span><br><span class="line">kubectl lable node --all hello- </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pods 的标签</span></span><br><span class="line">kubectl get pods --show--label</span><br><span class="line"><span class="comment"># 为名 test-web 的 pod 打上 nginx-pod=true 标签</span></span><br><span class="line">kubectl lable pods test-web nginx-pod=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 根据文件资源文件中定义的 kind、metadata.namespace、metadata.name 找到对应的 pod 打上 hello=world 标签</span></span><br><span class="line">kubectl label pod -f xxx.yaml hello=world</span><br></pre></td></tr></table></figure></li>
<li>kubectl exec 命令，在宿主机执行 Pod 中容器的命令，跟 docker exec 类似<br>命令语法格式：<code> kubectl exec &lt;pod-name&gt; [-n 命名空间] [ -c Pod 中容器名称 ] [ -it ]  -- &lt;container-command&gt;</code></li>
</ol>
<ul>
<li>-n 指定命名空间，不指定的话，默认是 default 命名空间下的 Pod</li>
<li>pod-name 指定 Pod 的名称</li>
<li>-c 指定运行 Pod 中的哪个容器的命令，如果不指定默认随机运行一个</li>
<li>container-command 指定容器要运行的命令，如 bash、ls、cat、date 等等想要运行的命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 default 命名空间下 test-web 内的 web01 容器中</span></span><br><span class="line">kubectl <span class="built_in">exec</span>  test-web -c web01 -it -- /bin/sh </span><br></pre></td></tr></table></figure>

<h2 id="4-Pod"><a href="#4-Pod" class="headerlink" title="4. Pod"></a>4. Pod</h2><p>Pod 是 k8s 的最小调度单位，Pod 包含一个或多个 Container(容器) ，K8s 创建 Pod 时，Pod 内容器默认使用的 Container 网络模式，所以在运行 Pod 中定义的容器之前，会先默认创建运行一个 init 容器，其他容器使用 init 容器的网络命名空间, 从而实现 Pod 内容器共享网络。即 Pod 内容器使用 localhost 就可以相互访问。注意 init 容器也是可以在资源文件中自定义，具体可以查看官方文档。<br>kubernetes 本身的组件也可以通过容器化的方式运行在集群中，并且都存在于 kube-system 命名空间下。注意 k8s 支持通过资源文件或者运行 kubectl run 创建 Pod。 </p>
<h3 id="4-1-定义-Pod-资源文件"><a href="#4-1-定义-Pod-资源文件" class="headerlink" title="4.1 定义 Pod 资源文件"></a>4.1 定义 Pod 资源文件</h3><p>使用<code>kubectl explain pod</code> 查看 pod 资源可以定义的属性和支持的版本</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="comment"># 注意要大写</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义 Pod 中的容器，可以多个</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">      <span class="comment"># 指定容器的名称, 注意 docker ps 查看容器的时候，看到的名字实际为： k8s_&lt;pod容器名&gt;_&lt;pod名&gt;_&lt;命名空间&gt;_&lt;uid&gt;_&lt;Priority&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line">      <span class="comment"># 指定容器运行的镜像</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="comment"># 指定镜像拉取的策略，可选值分别为，Always(总是从远程仓库拉取)、IfNotPresent(本地没有镜像时，才会从远程仓库拉取)、Never(只使用本地镜像，没有就报错) 默认是 IfNotPresent</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">          <span class="comment"># 容器 expose 的端口，在集群集群内，可以使用 Pod 分配的 ip 访问</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="comment"># 宿主机的端口，相当于 docker run -p 8000:80，可以使用 Pod 所在节点的 Ip 访问</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">8000</span> </span><br></pre></td></tr></table></figure>
<h3 id="4-2-操作-Pod-的常用命令"><a href="#4-2-操作-Pod-的常用命令" class="headerlink" title="4.2 操作 Pod 的常用命令"></a>4.2 操作 Pod 的常用命令</h3><ol>
<li>创建和更新 pod<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 pod，注意如果 yaml 文件或者不使用 -n 指定命名空间，则 pod 会创建在默认 default 命名空间下，是使用命令 kubectl explain pod.metadata 可以查看</span></span><br><span class="line">kubectl create pod -f xxx.yaml</span><br><span class="line"><span class="comment"># 创建或者更新 pod </span></span><br><span class="line">kubectl apply pod -f xxx.yaml</span><br></pre></td></tr></table></figure></li>
<li>删除 pod<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据名称删除 pod，如果不指定命名空间，则删除 default 命名空间下的 pod </span></span><br><span class="line">kubectl delete pod [pod-name] [-n 命名空间]</span><br><span class="line"><span class="comment"># 根据资源文件中的 kind、metadata.namespace、metadata.name 确定要删除的资源</span></span><br><span class="line">kubectl delete -f xxx.yaml</span><br></pre></td></tr></table></figure></li>
<li>查看 pod<br>第一种方式：使用 kubectl get pod [pod-name] [-o wide | yaml | json ] [-n 命名空间 | -A ]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不指定命名空间，默认查看 default 命名空间下的 pods</span></span><br><span class="line">kubectl get pod -o wide </span><br><span class="line"><span class="comment"># 查看所有命名空间的 pods</span></span><br><span class="line">kubectl get pod -A </span><br><span class="line"><span class="comment"># 根据名字查看指定的 pod 不指定命名空间，默认查看 default 命名空间的 pod </span></span><br><span class="line">kubectl get pod [pod-name]</span><br></pre></td></tr></table></figure>
第二种方式：kubectl describe pod [po-name] [-n 命名空间 | -A]，使用第二种方式，可以查看 pod 详细信息和 events 事件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 default 命名空间的下的所有 pod</span></span><br><span class="line">kubectl describe pod </span><br><span class="line"><span class="comment"># 根据名称查看 pod 信息，注意如果不指定命名空间，则默认查看 default 命名空间下的 pod </span></span><br><span class="line">kubectl describe pod [pod-name]</span><br></pre></td></tr></table></figure></li>
<li>pod 端口映射到宿主机端口<br>命令格式 <code>kubectl port-forward [pod-name] [hostPort:containerPort]</code>, 注意要 pod 所在的 node 节点运行才行<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 pod 端口映射到宿主机的端口, 注意 ip 地址要执行命令运行节点的才行</span></span><br><span class="line">kubectl port-forward test-web --address localhost,192.168.204.3  3000:80</span><br></pre></td></tr></table></figure></li>
<li>进入 Pod 内的容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> test-web -n default -c web01 -it -- bash</span><br><span class="line"><span class="comment"># 查看环境变量</span></span><br><span class="line">kubectl <span class="built_in">exec</span> test-web -n default -c web01 <span class="built_in">env</span> </span><br></pre></td></tr></table></figure></li>
<li>查看 Pod 内的容器日志<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs test-web -n default -c web01 -f --tail=200</span><br></pre></td></tr></table></figure></li>
<li>kubectl run 命令创建 Pod<br>命令语法格式: <code>kubectl run &lt;pod-name&gt; --image=image [--dry-run=server|client] </code> 具体查看帮助文档<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 --dry-run 参数，指定显示 Pod 的创建资源文件信息，不实际运行 Pod</span></span><br><span class="line">kubectl run test-web  --image=nginx --dry-run=client -o yaml  </span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-3-Pod-容器数据持久化，即容器挂载目录到宿主机，防止数据丢失"><a href="#4-3-Pod-容器数据持久化，即容器挂载目录到宿主机，防止数据丢失" class="headerlink" title="4.3 Pod 容器数据持久化，即容器挂载目录到宿主机，防止数据丢失"></a>4.3 Pod 容器数据持久化，即容器挂载目录到宿主机，防止数据丢失</h3><p>第一种方式：通过 volumes 和 volumeMounts 定义挂载的目录，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 指定将 Pod 资源创建在标签为 hello=world 的 node 主机节点中，注意如果多个 node 节点都存在 hello=world 标签, k8s 会调度选定一个节点，</span></span><br><span class="line">  <span class="comment"># 如果固定选择某个 node 节点，需要标签唯一</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="comment">#注意在，在 yaml 中定义或者使用 label 时用 : 代替 = </span></span><br><span class="line">    <span class="attr">hello:</span> <span class="string">world</span> </span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-data</span></span><br><span class="line">      <span class="attr">hostPath:</span> <span class="comment"># 定义挂载的宿主机目录</span></span><br><span class="line">        <span class="comment"># 注意该目录是 node 节点主机的目录，Pod 创建时调度到不确定的节点，最好使用 nfs、ceph、glusterfs 文件共享存储目录,</span></span><br><span class="line">        <span class="comment"># 或者通过 nodeSelector 指定 pod 部署的节点，才能保证，Pod 删除后重新创建时，挂载目录还是固定的主机目录 </span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/opt/data</span> </span><br><span class="line">        <span class="comment"># 指向一个目录，不存在时自动创建</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>     </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span> <span class="comment"># 容器名字</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span> <span class="comment"># 镜像</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-data</span> <span class="comment"># 注意 name 要跟上面 hostPath 的名字一样，因为是根据名字取匹配的</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span>  <span class="comment"># 指定容器的挂载目录</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-Pod-重启策略"><a href="#4-4-Pod-重启策略" class="headerlink" title="4.4 Pod 重启策略"></a>4.4 Pod 重启策略</h3><p>Pod 重启策略(RestartPolicy)，定义容器的重启规则，当 Pod 内某个容器异常退出或者探针健康检测失败时，kubelet 会根据重启策略(RestartPolicy)来进行相应的操作。Pod 的重启策略有三种分别是 Always、OnFailure、Never，默认值是 Always。</p>
<ul>
<li>Always 当容器进程退出时，kubelet 总是会自动重启容器</li>
<li>OnFailure 当容器终止运行且退出码不为0时，kubelet 会自动重启容器</li>
<li>Never 当前容器运行状态如何，kubelet 都不会自动启动容器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod </span><br><span class="line">metadata:</span><br><span class="line">  name: test-web</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  restartPolicy: OnFailure</span><br><span class="line">  containers:</span><br><span class="line">    - name: busybox</span><br><span class="line">      image: busybox</span><br><span class="line">      <span class="comment"># 命令正常执行成功返回的 0，设置退出码为 1 测试 OnFailure 重启策略</span></span><br><span class="line">      args: </span><br><span class="line">        - /bin/sh</span><br><span class="line">        - c </span><br><span class="line">        - <span class="built_in">sleep</span> 10 &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-5-容器-Probe-探针"><a href="#4-5-容器-Probe-探针" class="headerlink" title="4.5 容器 Probe(探针)"></a>4.5 容器 Probe(探针)</h3><p>probe(探针) 是由 kubelet 对容器定期执行的健康诊断。 诊断的方式是 kubelet 在容器内执行代码，或者发送一个网络请求。如果没有在资源文件中定义 prode 则 kubelet 会默认所有的诊断结果都是健康的。</p>
<h4 id="4-5-1-探针检测的方式"><a href="#4-5-1-探针检测的方式" class="headerlink" title="4.5.1 探针检测的方式"></a>4.5.1 探针检测的方式</h4><ul>
<li>exec 在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</li>
<li>gRPC 如果容器中实现 gRPC健康检查，可以使用 gRPC 执行一个远程过程调用。如果响应的状态是 SERVING，则认为诊断成功。</li>
<li>httpGet 对容器服务发起 HTTP GET 请求。如果响应的状态码大于等于 200 且小于 400，则任务诊断成功。</li>
<li>tcpSocket 对容器的指定端口执行 TCP 检查。如果端口打开，则诊断被认为成功</li>
</ul>
<h4 id="4-5-2-探测结果"><a href="#4-5-2-探测结果" class="headerlink" title="4.5.2 探测结果"></a>4.5.2 探测结果</h4><p>每次探测都将获得以下三种结果之一：</p>
<ul>
<li>Success（成功） 容器通过了诊断。</li>
<li>Failure（失败）容器未通过诊断。</li>
<li>Unknown（未知） 诊断失败，不会采取任何行动。</li>
</ul>
<h4 id="4-5-3-探针的类型"><a href="#4-5-3-探针的类型" class="headerlink" title="4.5.3 探针的类型"></a>4.5.3 探针的类型</h4><p>k8s 提供了三种容器探针，分别如下：</p>
<ul>
<li>startupProbe 启动探针，用于诊断容器中的服务是否已经启动成功，如果探针检测返回失败结果，则 kubelet 会杀死容器，并且根据容器重启策略(RestartPolicy)决定是否重启。注意该探针如果诊断成功之前不会运行 livenessProbe 和 readinessProbe 探针，未资源文件中配置 startupProbe 探针，则 kubelet 默认是诊断成功的。</li>
<li>livenessProbe 存活探针，用于诊断容器是否已经挂掉了，如果探针检测返回失败结果，则 kubelet 会杀死容器，并且根据容器重启策略(RestartPolicy)决定是否重启。</li>
<li>readinessProbe 就绪(READY)探针，用于诊断容器中的服务是否能正常接收请求，如果探针检测返回失败结果，Endpoint 控制器将 Pod 从 Endpoint 对应的服务中移除，不会将任何请求发送该 Pod 上，直到探针检测返回成功结果为止。</li>
</ul>
<ol>
<li>livenessProbe 存活探针例子，使用 <code>kubectl describe pod &lt;pod-name&gt;</code>命令查看检测是否成功，如果失败会有事件提示。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="comment"># kubectl 每3秒请求一次 /index 如果请求返回的状态码范围是 200 &lt;= statuCode &lt; 400 说检测成功</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/index</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">5</span> <span class="comment"># 表示容器运行5秒后，kubelet 开始检测</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span> <span class="comment"># 表示每隔 3 秒 kubelet 检测一次</span></span><br><span class="line">        <span class="attr">successThreshold:</span> <span class="number">3</span> <span class="comment"># 表示3次检测成功才算是检测成功，主要防止出现误差，默认值是 1</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">3</span> <span class="comment"># 表示3次检测失败才算是检测失败，主要防止出现误差，默认值是 1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-6-Pod-容器资源限制"><a href="#4-6-Pod-容器资源限制" class="headerlink" title="4.6 Pod 容器资源限制"></a>4.6 Pod 容器资源限制</h3><p>Pod 内容器运行依赖的硬件资源，最重要的指标就是 cpu 和内存，k8s 提供 requests 和 limits 两种参数类型来分配和限制容器使用的资源。它们的区别如下：</p>
<ul>
<li>requests 限制的资源只是作为 k8s 创建 Pod 时调度到指定节点的判断依据，不限制容器运行资源，只有主机节点的可分配资源大于等于 requests 限制的资源时，才允许 Pod 调度到此节点。</li>
<li>limits 限制 Pod 内容器能使用的最大资源，如果容器使用的内存超出设置值，则会报 OOM。如果内存和 cpu 的值都设置为 0 则 表示资源不作限制。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">sepc:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="comment"># 使用命令 kubectl describe node [node-name] 能查看主机节点的内存和 cpu </span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">50m</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">100m</span> </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-7-Pod-状态和生命周期"><a href="#4-7-Pod-状态和生命周期" class="headerlink" title="4.7 Pod 状态和生命周期"></a>4.7 Pod 状态和生命周期</h3><h4 id="4-7-1-生命周期"><a href="#4-7-1-生命周期" class="headerlink" title="4.7.1 生命周期"></a>4.7.1 生命周期</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gantt</span><br><span class="line">  title Pod 生命周期</span><br><span class="line">  dateFormat ss</span><br><span class="line">  axisFormat %Ss</span><br><span class="line">  pod start : milestone, s1, 00, 0s</span><br><span class="line">  section Init Container</span><br><span class="line">  # 内容，颜色、标签、起始点，</span><br><span class="line">  init Container-01 : i1, 00, 3s</span><br><span class="line">  init Container-02 : i1, 01, 3s</span><br><span class="line">  init Container-03 : i1, 02, 3s</span><br><span class="line">  section Main Container</span><br><span class="line">  post start hook:  m1, 05, 2s</span><br><span class="line">  main container: m1, 05, 6s</span><br><span class="line">  livenessProbe: m1, 07, 2s</span><br><span class="line">  readinessProbe: m1, 07, 2s</span><br><span class="line">  pre stop hook: m1, 09, 2s</span><br><span class="line">  section  </span><br><span class="line">  pod stop : milestone, crit, s1, 11, 0s</span><br></pre></td></tr></table></figure>
<p>Pod 资源对象从创建到结束的时间段称为 Pod 的生命周期，Pod 周期过程和钩子函数说明如下：</p>
<ol>
<li>Pod 创建过程</li>
<li>运行初始化容器(init container)过程</li>
<li>运行主容器(main container)过程<ul>
<li>容器启动后执行的钩子函数（post start），容器终止前执行的钩子函数（ pre stop）</li>
<li>容器的存活性探测(liveness probe)、就绪性探测(readiness probe)</li>
</ul>
</li>
<li>Pod 终止过程<ul>
<li>执行删除命令，k8s 给需要删除的 Pod 发出 SIGTERM 信号，Pod 状态变为 Terminating</li>
<li>kube-proxy watch 监控到 Pod 的状态不是 READY 状态，将 Pod 从 service 的 endpoint 列表中摘除掉，新的流量不再转发到该 Pod</li>
<li>kubelet watch 监控到 Terminating 状态，则开始销毁 Pod，如果 Pod 中的容器配置了  preStop Hook 将会执行，<br>发送 SIGTERM 信号给容器内主进程以通知容器进程开始停止，并等待 container 中的主进程完全停止，如果在 terminationGracePeriodSeconds 内 (默认 30s) 还未完全停止，就发送 SIGKILL 信号将其强制杀死，所有容器进程终止，清理 Pod 资源，完成 Pod 删除</li>
</ul>
</li>
</ol>
<h4 id="4-7-2-Pod-状态和容器状态"><a href="#4-7-2-Pod-状态和容器状态" class="headerlink" title="4.7.2 Pod 状态和容器状态"></a>4.7.2 Pod 状态和容器状态</h4><ol>
<li>Pod 生命周期中各种状态说明</li>
</ol>
<ul>
<li>Pending（等待中）	Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</li>
<li>Running（运行中）	Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。</li>
<li>Succeeded（成功）	Pod 中的所有容器都已成功终止，并且不会再重启。</li>
<li>Failed（失败）	Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</li>
<li>Unknown（未知）	因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</li>
</ul>
<ol start="2">
<li>Pod 内容器生命周期状态</li>
</ol>
<ul>
<li>Waiting （等待） 容器运行前的等待状态，如拉取容器镜像，或者向容器应用 Secret 数据等等。</li>
<li>Running（运行中） 表明容器正在执行状态并且没有问题发生。</li>
<li>Terminated（已终止） 容器已经开始执行并且或者正常结束或者因为某些原因失败。</li>
</ul>
<h3 id="4-8-静态-Pod"><a href="#4-8-静态-Pod" class="headerlink" title="4.8 静态 Pod"></a>4.8 静态 Pod</h3><p>静态 Pod 指的是 kubelet 自动创建的 Pod，不需要我们使用<code>kubectl &lt;create|apply&gt;</code>手动创建。静态 Pod 的 yaml 是存放在 <code>/etc/kubernetes/manifests/</code> 中的，kubectl 会自动扫描该目录的 yaml 文件并自动创建，创建的 Pod 即为静态 Pod。如果我们想创建静态 Pod 直接将 yaml 放到该目录即可，kubectl 会自动创建。</p>
<h2 id="5-ConfigMap-和-Secret"><a href="#5-ConfigMap-和-Secret" class="headerlink" title="5. ConfigMap 和 Secret"></a>5. ConfigMap 和 Secret</h2><p>k8s 提供 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> 和 Secret 两种不同类型的资源，来实现业务配置信息的统一管理。在静态 Pod 中无法使用配置资源。</p>
<ol>
<li>ConfigMap 用于管理不敏感的配置项。ConfigMap 资源的定义如下：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web-config</span></span><br><span class="line">  <span class="comment"># 不指定命名空间的话，资源默认在 default 命名空间下</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># 定义配置项，注意如果 Pod 是以挂载文件的方式引用 configMap 则 data 中的每 key-value 键值对都会单独生成一个文件，key 作为文件名，vlaue 作为文件内容 </span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 简单键值对配置项，注意值要加引号，不然会报错</span></span><br><span class="line">  <span class="attr">redis_host:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="attr">redis_port:</span> <span class="string">&quot;6739&quot;</span></span><br><span class="line">  <span class="comment"># 类似文件的配置项</span></span><br><span class="line">  <span class="comment"># | 在 yaml 中表示每一行都保留换行符号 \n</span></span><br><span class="line">  <span class="attr">game.properties:</span> <span class="string">|   </span></span><br><span class="line"><span class="string">    enemy.types=aliens,monsters</span></span><br><span class="line"><span class="string">    player.maximum-lives=5    </span></span><br><span class="line"><span class="string"></span>  <span class="attr">user-interface.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    color.good=purple</span></span><br><span class="line"><span class="string">    color.bad=yellow</span></span><br><span class="line"><span class="string">    allow.textmode=true  </span></span><br><span class="line"><span class="string"></span>  <span class="attr">test-web.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    server &#123;</span></span><br><span class="line"><span class="string">      listen       81;</span></span><br><span class="line"><span class="string">      listen  [::]:81;</span></span><br><span class="line"><span class="string">      server_name  localhost;</span></span><br><span class="line"><span class="string">      #access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class="line"><span class="string">      location / &#123;</span></span><br><span class="line"><span class="string">        root   /usr/share/nginx/html;</span></span><br><span class="line"><span class="string">        index  index.html index.htm;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure></li>
<li>Secret 用于管理中的配置信息，如账号密码，等等敏感配置信息。Secret 资源的定义如下：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web-secret</span></span><br><span class="line">  <span class="comment"># 不指定命名空间的话，资源默认在 default 命名空间下</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span> </span><br><span class="line"><span class="comment"># type 指定 data 能定义哪些配置项，Opaque 表示用户可以定义的任意数据，当类型为 kubernetes.io/service-account-token 时 data 中只能配置 k8s 服务账号令牌</span></span><br><span class="line"><span class="comment"># 具体查看： https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#secret-types</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="comment"># 定义应用使用的配置项</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 与configMap的区别是。配置项的值需要 base64 编码</span></span><br><span class="line">  <span class="attr">db_username:</span> <span class="string">&quot;YWRtaW4K&quot;</span></span><br><span class="line">  <span class="attr">db_password:</span> <span class="string">&quot;MTIzNDU2Cg==&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>创建和查看 configMap 和 Secret 跟 Pod 一样操作即可<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建资源</span></span><br><span class="line">kubectl create -f test-web-config.yaml</span><br><span class="line"><span class="comment"># 查看资源, 不指定命名空间，默认查看的是 default 命名空间的</span></span><br><span class="line">kubectl get &lt;configmap | cm&gt; [资源名]</span><br><span class="line">或者</span><br><span class="line">kubectl describe &lt;configmap | cm&gt; [资源名]</span><br></pre></td></tr></table></figure></li>
<li>通过内容为 <code>key=value </code> 格式的文件创建 configMap 资源<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 key=value 文件创建 configMap 资源</span></span><br><span class="line">kubectl create configmap test-web-config -n default --from-env-file=configs.txt</span><br><span class="line"><span class="comment"># 通过 key=value 文件创建 secret 注意文件中的 value 是需要 base64 的</span></span><br><span class="line">kubectl create configmap ggeneric test-web-config -n default --from-env-file=configs.txt</span><br><span class="line"><span class="comment"># configs.txt 的文件内容格式如下</span></span><br><span class="line">hello=<span class="string">&quot;world&quot;</span></span><br><span class="line">lang=<span class="string">&quot;en&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>Pod 内容器服务使用 ConfigMap 和 Secret 资源中的配置项，方式如下：</li>
</ol>
<ul>
<li>作为环境变量使用，注意 Pod 和 ConfigMap 必须要在同一个命名空间中<br>使用命令  <code>kubectl exec test-web -c web01  -- env </code> 可以查看容器环境变量<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web01</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="comment"># 使用 envFrom 将所有 ConfigMap 的数据定义为容器环境变量</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">test-web-config</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># 定义环境变量 db_url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db_url</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">jdbc://mysql/xxx//xx/xx</span></span><br><span class="line">        <span class="comment"># 定义环境变量 test-env-json </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-env-json</span>  </span><br><span class="line">          <span class="comment"># | 符号，表示值可以换行和值中保留换行符号        </span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">| </span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              &quot;hello&quot;:90</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span>        <span class="comment"># 定义环境变量 db_password，变量的值从 Secret 资源中获取</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db_password</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="comment"># Secret 的资源名</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">test-web-secret</span></span><br><span class="line">                <span class="comment"># 获取 Secret 资源中 db_password 的值</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">db_password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_port</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">test-web-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">redis_port</span></span><br><span class="line">          <span class="comment"># 定义环境变量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apiversion</span></span><br><span class="line">          <span class="comment"># 将 Pod 信息存到环境变量中 </span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="comment"># 环境变量中获取 Pod IP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod_ip</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-file-demo</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/etc/web-config&quot;</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-config-file</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/etc/nginx/conf.d&quot;</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-file-demo</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-web-config</span></span><br><span class="line">        <span class="comment"># 指定哪些 key 可以在容器 /etc/web-config 目录下生成文件，不指定的话，所有 Key 都会生成文件 </span></span><br><span class="line">        <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;game.properties&quot;</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">&quot;game.properties&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-config-file</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-web-config</span></span><br><span class="line">        <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;test-web.conf&quot;</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">&quot;test-web.conf&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>将配置资源挂载为容器文件<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web-02</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-config</span></span><br><span class="line">      <span class="comment"># test-web-secret 中的 data 的每一个配置项都会在容器目录 /etc/config 中生成文件，key 作为文件名，value 是文件的内容  </span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/config&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-config</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">test-web-secret</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="6-工作负载-Workload"><a href="#6-工作负载-Workload" class="headerlink" title="6. 工作负载(Workload)"></a>6. 工作负载(Workload)</h2><p>工作负载又称 Pod 控制器用于管理 Pod，比如创建 Pod 副本、扩容或者升级版本等等，确保 Pod 资源能处于预期的工作状态中，Pod 资源遇到故障时能，会根据策略自动重启或者重新新建 Pod<br>资源，k8s 提供的工作负载资源有以下几种：</p>
<ul>
<li>ReplicaSet 自动创建指定数量的 Pod 副本，并且支持滚动式自动扩容和缩容功能</li>
<li>Deployment 以 ReplicaSet 为基础，进一步的封装，用于管理无状态的应用，支持副本创建伸缩的同时，支持滚动更新和回滚功能</li>
<li>DaemonSet 用于确集群中的每一个 Node 节点都运行特定的 Pod 副本，比如用于定义每个节点上都运行日志收集类的 Pod，因为每一个节点的日志都需要收集</li>
<li>Job 用于管理运行完就退出的 Pod，不需要重启或者重建的 Pod 资源</li>
<li>CronJob 用于运行周期性任务的 Pod，不需要后台持久性运行</li>
<li>StatefulSet 用于管理有状态的应用</li>
</ul>
<h3 id="6-1-工作负载如何控制-Pod"><a href="#6-1-工作负载如何控制-Pod" class="headerlink" title="6.1 工作负载如何控制 Pod"></a>6.1 工作负载如何控制 Pod</h3><p>工作负载(Workload)是通过标签去关联 Pod 的，工作负载通过属性 spec.selector.matchLabels 指定要管理的 Pod 的标签</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flowchart TB</span><br><span class="line">    A([&quot;工作负载(Workload)&quot;])</span><br><span class="line">    A -- lables: app:nginx --&gt; P1[&quot;Pod&quot;]</span><br><span class="line">    A -- lables: app:nginx --&gt; P2[&quot;Pod&quot;]</span><br><span class="line">    A -- lables: app:nginx --&gt; P3[&quot;Pod&quot;]</span><br></pre></td></tr></table></figure>

<h3 id="6-2-Deployment-工作负载"><a href="#6-2-Deployment-工作负载" class="headerlink" title="6.2 Deployment 工作负载"></a>6.2 Deployment 工作负载</h3><h3 id="6-2-1-创建-Deployment"><a href="#6-2-1-创建-Deployment" class="headerlink" title="6.2.1 创建 Deployment"></a>6.2.1 创建 Deployment</h3><ol>
<li><p>Deployment 的声明式文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 指定 Pod 的副本个数</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 根据标签选择要控制的 Pod</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="comment"># template 属性声明定义 Pod 的信息 </span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># 定义 Pod 的标签 </span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li>
<li><p>声明式文件创建 Deployment 使用如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 执行创建或更新资源命令时加上 --record=true 参数，k8s 会将当前执行的创建或者更新命令记录在资源的 annotations 属性中</span><br><span class="line">kubectl create -f nginx-deployment.yaml --record=true</span><br><span class="line"># 或者</span><br><span class="line">kubectl apply -f nginx-deployment.yaml</span><br></pre></td></tr></table></figure></li>
<li><p>命令行方式创建 Deployment 的方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx-depoyment --image=nginx --replicas=3</span><br></pre></td></tr></table></figure></li>
<li><p>查看 Deployment 信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看默认命名空间下的所有 deployment </span></span><br><span class="line">kubectl get deployments</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据名称查看默认命名空间下的 deployment</span></span><br><span class="line">kubectl get deployments nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># deployment 是 replicasets 的扩展封装，在创建 Deployment 的同时创建了 ReplicaSet</span></span><br><span class="line">kubectl get replicasets  -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 deployment 信息和事件 </span></span><br><span class="line">kubectl describe deployment nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Depoyment 的状态</span></span><br><span class="line">kubectl rollout status deployment nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除 Deloyment </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式一，通过 yaml 文件删除</span></span><br><span class="line">kubectl delete -f nginx-deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二，通过 deloyment 名称删除</span></span><br><span class="line">kubectl delete depolyment nginx-deloyment</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 Deployment </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout restart deployment nginx-deployment</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-2-2-更新-Deployment"><a href="#6-2-2-更新-Deployment" class="headerlink" title="6.2.2 更新 Deployment"></a>6.2.2 更新 Deployment</h3><ol>
<li>更新副本数量</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一种方式，命令行通过指定 --replicas 参数，来修改</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种方式，修改 yaml 文件中的 replicas 属性，然后执行更新</span></span><br><span class="line">kubectl apply -f nginx-deloyment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三种方式，通过 kubectl edit 命令直接修改 replicas 属性，即可生效</span></span><br><span class="line">kubectl edit deployment nginx-deployment</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意，创建 Deployment 资源时，也会创建 replicaset ，如果想通过修改 replicaset 资源的副本数量，去改变 Deployment 创建的副本数量是行不通，如下： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment 的副本数量并不会变</span></span><br><span class="line">kubectl scale replicaset nginx-deployment-687df7cddc --replicas=2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>更新镜像版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一种方式，直接修改 yaml 文件，然后更新</span></span><br><span class="line">kubectl apply -f nginx-deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种方式，kubectl edit 命令直接修改</span></span><br><span class="line">kubectl edit deployment nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三种方式，使用 kubectl set image 命令</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment nginx-deployment nginx=nginx:1.9.1 <span class="comment"># 将所有 nginx 镜像改成 nginx:1.9.1</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment nginx-deployment busybox=busybox nginx=nginx:1.9.1 <span class="comment"># 将所有 busybox 和 nginx 镜像分别改成busybox 和 nginx:1.9.1</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment nginx-deployment *=nginx:1.9.1 <span class="comment"># 将所有 deployment 中的镜像都改成 nginx:1.9.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四种方式使用命令 kubectl patch 使用补丁的方式修改更新资源的字段</span></span><br><span class="line">kubectl patch deployment nginx-deployment --patch <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;template&quot;: &#123;&quot;spec&quot;: &#123;&quot;containers&quot;: [&#123;&quot;name&quot;: &quot;nginx&quot;,&quot;image&quot;:&quot;nginx:1.9.1&quot;&#125;]&#125;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>暂停和恢复 Pod 资源更新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 deployment 的状态标记为 pause 状态时，更新镜像时则会被暂停，当使用 kubectl rollout resume 命令恢复状态时，会继续执行之前暂停的更新命令</span></span><br><span class="line">kubectl rollout pause deployment nginx-deployment</span><br><span class="line"><span class="comment"># 将 Deployment 从 pause 状态恢复到 kubectl rollout status 查看到的状态</span></span><br><span class="line">kubectl rollout resume deployment test-k8s-deployment</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-2-3-Deployment-查看历史和回滚"><a href="#6-2-3-Deployment-查看历史和回滚" class="headerlink" title="6.2.3 Deployment 查看历史和回滚"></a>6.2.3 Deployment 查看历史和回滚</h3><p>Deployment 资源中 Pod 信息的更改时，才会记录历史记录，比如修改镜像的名称、版本号等都是记录为历史记录，但是 Deployment 副本的伸缩或者其他非 Pod 信息改动不会记录历史版本，只是会将版本号递增</p>
<ol>
<li>查看历史记录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看历史记录版本列表，其中结果列 CHANGE-CAUSE 显示的是 delopyment 资源 annotations 属性下的 kubernetes.io/change-cause 属性，如果不存在会显示为 &lt;none&gt;</span></span><br><span class="line"><span class="comment"># annotations.kubernetes.io/change-cause 属性是执行创建或者更新资源命令添加 --record 参数，才指定增加的属性</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment test-k8s-deployment</span><br><span class="line"><span class="comment"># 查看历史记录的详细信息需要指定版本，注意只有详细信息里面的属性改动时才会记录历史记录，其他的改动只会改变版本号</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment test-k8s-deployment --revision=1</span><br><span class="line"><span class="comment"># 查看历史版本详情信息</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment test-k8s-deployment -oyaml</span><br></pre></td></tr></table></figure></li>
<li>回滚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#回滚到指定历史版本</span></span><br><span class="line">kubectl rollout undo deployment nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-2-4-更新策略-strategy"><a href="#6-2-4-更新策略-strategy" class="headerlink" title="6.2.4 更新策略(strategy)"></a>6.2.4 更新策略(strategy)</h3><p>Deployment 控制器提供了两种更新策略，分别是：</p>
<ul>
<li>Recreate  在更新新的 Pod 之前，先把旧的 Pod 全部先删除掉</li>
<li>RollingUpdate  滚动更新，根据指定的规则先创建新的 Pod 在删除旧的 Pods</li>
</ul>
<p>Deployment 默认使用的是 RollingUpdate 策略，它是一种平滑的滚动更新方式，可以保证服务的高可用，使RollingUpdate 策略时，需要设置 maxUnavailable 和 maxSurge 参数值，说明如下：</p>
<ul>
<li>maxUnavailable 表示在更新过程中，最多有多少个 Pod 不可用，值可以是数值或者百分比，默认值是 25%，计算结果向下取整</li>
<li>maxSurge 表示在更新过程中，Pod 的个数最大峰值，值可以是数值或者百分比，默认值是 25%，注意计算结果向上取整，跟 maxUnavailable 的取整结果相反</li>
</ul>
<p>列如有 8 个 Pods 需要更新，如果 maxUnavailable 和 maxSurge 都按默认值 25 % 来计算，那么得出以下规则：</p>
<ul>
<li>在更新过程中，Pods 的数量最大值为 10 &#x3D; (8 + 8 * 0.25maxSurge)</li>
<li>在更新过程中，Ready 状态 Pods 数量至少大于等于 6 &#x3D; (8 - 8*0.25maxUnavailable)<br>使用 <code>kubectl describe deployment nginx-deployment </code> 命令查看 Deployment 的升级事件，如下：<br><img src="/images/%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7%E4%BA%8B%E4%BB%B6.png" alt="滚动升级事件"><br>由可以看到滚动升级的过程如下：</li>
<li>启动 maxSurge 个 Pods</li>
<li>关闭 maxUnavailable 个 pods</li>
<li>启动 maxUnavailable 个 Pods </li>
<li>关闭 1 个 Pod</li>
<li>启动 1 个 Pod </li>
<li>关闭 1 个 Pod</li>
<li>启动 1 个 Pod，后面一直重复，启动一个关闭一个，直到 Pods 版本更新完成</li>
</ul>
<h2 id="7-Service"><a href="#7-Service" class="headerlink" title="7. Service"></a>7. Service</h2><p>Service 资源是一组 Pods 的抽象服务，可以看成是一组 Pods 的负载均衡(LB)，创建 Service 资源时，K8s 会为 Serivce 资源生成一个虚拟 IP，又称<br>ClusterIP(集群IP)。访问该 ClusterIP 时，Serivice 会负责将请求转发给对应的 Pod。</p>
<p>Service 主要有以下特性：</p>
<ul>
<li>Service 是通过 label 去关联对应的 Pods</li>
<li>Servcie 只会监控 Ready 状态的 Pods</li>
<li>提供了负载均衡功能，能自动转发流量到不同 Pod 副本上</li>
<li>集群内所有的 Pods 的内部都可以通过服务名字或者服务虚拟 IP 访问，但在节点中只能虚拟 IP 访问，注意在 Pod 内部使用服务名访问时，如果是不同的命名空间下，需要在服务名后面加命名空间</li>
</ul>
<h3 id="7-1-Service-资源文件式声明定义"><a href="#7-1-Service-资源文件式声明定义" class="headerlink" title="7.1 Service 资源文件式声明定义"></a>7.1 Service 资源文件式声明定义</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 根据 label 关联 Pods, 并根据 label 实时 Watch Pods 的状态</span></span><br><span class="line">  <span class="comment"># 如果 Pod 是 Ready 状态，就将 Pod 加入 Service 的 Endpoints 中，不是就将其从 Service 的 Endpoints 中剔除 </span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s-pod</span></span><br><span class="line">  <span class="comment"># type 支持四种类型分别是 ClusterIP、NodePort、LoadBalancer、ExternalName</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="comment"># 本 Service 的端口</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">      <span class="comment"># Pod 应用的端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># 三个横线表示是将文件分成多个 yaml 文件</span></span><br><span class="line"><span class="meta">--- </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s-pod</span></span><br><span class="line">  <span class="comment"># 表示除了可以通过使用 Service 的名称和IP 访问该 Service 负载均衡的 Pods 外</span></span><br><span class="line">  <span class="comment"># 还可以通过通过每个节点的 IP 加 nodePort 访问</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="comment"># ports 指定多个端口时，必须指定 name</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="comment"># 本 Service 的端口</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">      <span class="comment"># Pod 应用的端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># 节点端口，如果不指定的话，创建时会默认从范围 30000 ~ 32767 中指定一个</span></span><br><span class="line">      <span class="comment"># 集群节点的端口，注意每节点的 Kube-Proxy 组件都会监听改端口，所有每个节点的 IP 都可以访问 Service 服务</span></span><br><span class="line">      <span class="attr">nodePort:</span>  <span class="number">30458</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-service-001</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8889</span></span><br><span class="line">      <span class="comment"># Pod 应用的端口，如果 Pod 应用的 ports 属性定义 name 则 targetPort 的值也可以设置为 Pod 端口的 name</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">81</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30459</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-service-002</span></span><br></pre></td></tr></table></figure>

<p>Service 资源的的 Type 说明如下：</p>
<ul>
<li>ClusterIP：通过集群内的 ClusterIP 暴露服务，选择该值时服务只能够在集群内部访问。注意 ClusterIP 是可以在配置文件中固定写死一个值的。</li>
<li>NodePort：通过集群节点 IP 和集群 ClusterIP 暴露服务。</li>
<li>LoadBalancer：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 NodePort 服务和 ClusterIP 服务上。</li>
<li>ExternalName：通过返回 CNAME 和对应值，可以将服务映射到 externalName 字段的内容（例如，foo.bar.example.com）。 无需创建任何类型代理。</li>
</ul>
<p>两个注意点：</p>
<ul>
<li>通过服务名访问服务，只能在 Pod 的容器内部使用。Pod 容器中的 <code>/etc/resolv.conf</code> 文件，维护有 Core-DNS 组件的 IP 地址，使用服务名访问会通过该 IP 去访问 Core-DNS 将服务名<br>解析成服务的 ClusterIP</li>
<li>nodePort 实际上是由节点上的 Kube-proxy 组件监听的，通过节点 IP 访问服务时，实际是访问 kube-proxy 在转发到 Service 服务</li>
</ul>
<h3 id="7-1-2-操作资源的常用命令"><a href="#7-1-2-操作资源的常用命令" class="headerlink" title="7.1.2 操作资源的常用命令"></a>7.1.2 操作资源的常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过资源配置文件创建资源</span></span><br><span class="line">kubectl apply -f [test-service.yaml]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看默认命名空间下的资源信息</span></span><br><span class="line">kubectl get service -owide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务详情和 Endpoints(Pods 的应用的访问地址)</span></span><br><span class="line">kubectl describe svc [资源名]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务资源的 endpoints</span></span><br><span class="line">kubectl get endpoints</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据资源配置文件删除资源</span></span><br><span class="line">kebectl delete -f [test-service.yaml]</span><br><span class="line"><span class="comment"># 通过资源名称删除资源</span></span><br><span class="line">kubectl delete service [test-service]</span><br></pre></td></tr></table></figure>

<h2 id="8-Ingress"><a href="#8-Ingress" class="headerlink" title="8. Ingress"></a>8. Ingress</h2><p>Ingress 为外部访问集群提供了一个 统一入口，避免了对外暴露集群端口，可以根据域名、路径把请求转发到不同的 Service 资源。Ingress 资源主要用于定义统一的访问配置和转发规则，去适配不同的负载均衡器，目前支持负载均衡器有 nginx、Haproxy, trafik, lstios 等等。</p>
<p>Ingress 资源只是提供访问转发路由的配置，实际访问配置和负责转发工作的是 Ingress 控制器，也就是底层的负载均衡器，ingress 控制器通过和 k8s API 交互，动态监控 ingress 资源中配置的规则。并将其更新到 ingress 控器 Pod 内的负载均衡应用中。如使用 ningx 控制器(ingress-nginx-controller)时，nginx 控制器通过 k8s API 实时监控 ingress 资源中配置的转发规则，当监控到 ingress 中<br>的配置规则时，会将 ingress 规则转发 nginx 配置规则，并实时写到 ingress-nginx-controller 的 Pod 里的 nginx 服务的 nginx.config 文件中和在控制器中运行<code>nginx -s reload</code>动态实时生效配置。外部流量访问时，访问的是 ingress-nginx 控制器中 pod 的 nginx 服务，所以部署 ingress-nginx 控制器时候要指定 Deployment 中 Pod 的网络默认为 host 或者将 Service 中的类型改成 NodePort。</p>
<p>注意Ingress 通过 Service 关联已经是 Ready 状态的 Pods，如下图所示：</p>
<p><img src="/images/Ingress-%E7%BD%91%E7%BB%9C.png" alt="Ingress网络"></p>
<h3 id="8-2-Ingress"><a href="#8-2-Ingress" class="headerlink" title="8.2 Ingress"></a>8.2 Ingress</h3><p>Ingress 资源文件定义如下，注意 k8s 在 1.18 版本之前可以使用注解指定使用那种控制器，1.18 版本之后使用 ingressClassName</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 指定要使用的控制器类，ingress-nginx 控制器需要在 pods 容器的启动参数中设置 –-ingress-class=nginx </span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="comment"># 表示闭 https 连接，只使用 http 连接</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 如果规则不指定 host 则表示匹配所有域名</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/hello</span></span><br><span class="line">            <span class="comment"># 匹配路径的规则有三个可选值，Prefix 表示按路径前缀匹配，区分大小写，Exact 表示全路径精准匹配，区分大小写，ImplementationSpecific 匹配方法取决于 IngressClass 即取决于Ingress 控制器</span></span><br><span class="line">            <span class="comment"># 指定规则匹配后跳转到的 service 名称和端口</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="comment"># 支持两种写法，第一种写法</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">test-service</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">3000</span></span><br><span class="line">      <span class="comment"># host 支持 * 通配符号</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ecm.jintiantong.com</span></span><br><span class="line">      <span class="attr">http:</span> </span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="comment"># 第二种写法</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">test-service-01</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<h3 id="8-1-安装-Ingress-控制器"><a href="#8-1-安装-Ingress-控制器" class="headerlink" title="8.1 安装 Ingress 控制器"></a>8.1 安装 Ingress 控制器</h3><p>注意安装 Ingress 控制器的时候，可以更该 Pod 的配置 nodeSelector 表示需要将 Ingress 控制器的 Pod 部署在那个节点，默认是选择部署在有标签 kubernetes.io&#x2F;os&#x3D;linux 的节点</p>
<p>注意要将 ingress-nginx-controller 配置文件中的 Deployment 资源中将 Pods 网络默认改成 host 模式，或者 Service 资源的类型改成 NodePort, 如果 service 资源需要安装一个LB(负载均衡器，可以使用开源的 MetalLB)，通过 LB 在将流量转发到集群内部的Serive ClusterIP, 不然无法访问到 ingress 控制器里面的负载均衡器的。</p>
<p>注意 ingress-nginx-controller 资源安装文件中，可以 Pod 的控制器由 Deployment 改成 DaemonSet 控制，Pod 使用 host 模式时可以删除 service 资源配置不创建 Service 资源。</p>
<p>安装 ingress-nginx-controller 的资源文件如下：</p>
<details>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">automountServiceAccountToken: true</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - pods</span><br><span class="line">  - secrets</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingressclasses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resourceNames:</span><br><span class="line">  - ingress-nginx-leader</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - coordination.k8s.io</span><br><span class="line">  resourceNames:</span><br><span class="line">  - ingress-nginx-leader</span><br><span class="line">  resources:</span><br><span class="line">  - leases</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - coordination.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - leases</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - discovery.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - endpointslices</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - create</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - endpoints</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - secrets</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - coordination.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - leases</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingressclasses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - discovery.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - endpointslices</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - admissionregistration.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - validatingwebhookconfigurations</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - update</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  allow-snippet-annotations: &quot;true&quot;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  externalTrafficPolicy: Local</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv4</span><br><span class="line">  ipFamilyPolicy: SingleStack</span><br><span class="line">  ports:</span><br><span class="line">  - appProtocol: http</span><br><span class="line">    name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: http</span><br><span class="line">  - appProtocol: https</span><br><span class="line">    name: https</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: https</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-controller-admission</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - appProtocol: https</span><br><span class="line">    name: https-webhook</span><br><span class="line">    port: 443</span><br><span class="line">    targetPort: webhook</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  minReadySeconds: 0</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/component: controller</span><br><span class="line">      app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: controller</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">        - --election-id=ingress-nginx-leader</span><br><span class="line">        - --controller-class=k8s.io/ingress-nginx</span><br><span class="line">        - --ingress-class=nginx</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">        - --validating-webhook=:8443</span><br><span class="line">        - --validating-webhook-certificate=/usr/local/certificates/cert</span><br><span class="line">        - --validating-webhook-key=/usr/local/certificates/key</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: LD_PRELOAD</span><br><span class="line">          value: /usr/local/lib/libmimalloc.so</span><br><span class="line">        image: registry.k8s.io/ingress-nginx/controller:v1.5.1@sha256:4ba73c697770664c1e00e9f968de14e08f606ff961c76e5d7033a4a9c593c629</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        lifecycle:</span><br><span class="line">          preStop:</span><br><span class="line">            exec:</span><br><span class="line">              command:</span><br><span class="line">              - /wait-shutdown</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 10254</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        name: controller</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 443</span><br><span class="line">          name: https</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          name: webhook</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 10254</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 90Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: true</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          runAsUser: 101</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /usr/local/certificates/</span><br><span class="line">          name: webhook-cert</span><br><span class="line">          readOnly: true</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      serviceAccountName: ingress-nginx</span><br><span class="line">      terminationGracePeriodSeconds: 300</span><br><span class="line">      volumes:</span><br><span class="line">      - name: webhook-cert</span><br><span class="line">        secret:</span><br><span class="line">          secretName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission-create</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: admission-webhook</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">        app.kubernetes.io/version: 1.5.1</span><br><span class="line">      name: ingress-nginx-admission-create</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - create</span><br><span class="line">        - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span><br><span class="line">        - --namespace=$(POD_NAMESPACE)</span><br><span class="line">        - --secret-name=ingress-nginx-admission</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20220916-gd32f8c343@sha256:39c5b2e3310dc4264d638ad28d9d1d96c4cbb2b2dcfb52368fe4e3c63f61e10f</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: create</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 2000</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 2000</span><br><span class="line">      serviceAccountName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission-patch</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/component: admission-webhook</span><br><span class="line">        app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">        app.kubernetes.io/version: 1.5.1</span><br><span class="line">      name: ingress-nginx-admission-patch</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - patch</span><br><span class="line">        - --webhook-name=ingress-nginx-admission</span><br><span class="line">        - --namespace=$(POD_NAMESPACE)</span><br><span class="line">        - --patch-mutating=false</span><br><span class="line">        - --secret-name=ingress-nginx-admission</span><br><span class="line">        - --patch-failure-policy=Fail</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20220916-gd32f8c343@sha256:39c5b2e3310dc4264d638ad28d9d1d96c4cbb2b2dcfb52368fe4e3c63f61e10f</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: patch</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 2000</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 2000</span><br><span class="line">      serviceAccountName: ingress-nginx-admission</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: IngressClass</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  controller: k8s.io/ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: admissionregistration.k8s.io/v1</span><br><span class="line">kind: ValidatingWebhookConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: admission-webhook</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.5.1</span><br><span class="line">  name: ingress-nginx-admission</span><br><span class="line">webhooks:</span><br><span class="line">- admissionReviewVersions:</span><br><span class="line">  - v1</span><br><span class="line">  clientConfig:</span><br><span class="line">    service:</span><br><span class="line">      name: ingress-nginx-controller-admission</span><br><span class="line">      namespace: ingress-nginx</span><br><span class="line">      path: /networking/v1/ingresses</span><br><span class="line">  failurePolicy: Fail</span><br><span class="line">  matchPolicy: Equivalent</span><br><span class="line">  name: validate.nginx.ingress.kubernetes.io</span><br><span class="line">  rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - networking.k8s.io</span><br><span class="line">    apiVersions:</span><br><span class="line">    - v1</span><br><span class="line">    operations:</span><br><span class="line">    - CREATE</span><br><span class="line">    - UPDATE</span><br><span class="line">    resources:</span><br><span class="line">    - ingresses</span><br><span class="line">  sideEffects: None</span><br></pre></td></tr></table></figure>
</details>


<h2 id="9-0-Pods-调度"><a href="#9-0-Pods-调度" class="headerlink" title="9.0 Pods 调度"></a>9.0 Pods 调度</h2><p>调度指的是将 Pod 部署到合适的节点上，kube-scheduler 是 Kubernetes 集群的默认调度器。</p>
<h3 id="9-1-kube-scheduler-调度器"><a href="#9-1-kube-scheduler-调度器" class="headerlink" title="9.1 kube-scheduler 调度器"></a>9.1 kube-scheduler 调度器</h3><p>kube-scheduler 给一个 Pod 做调度时包含两个阶段：</p>
<ul>
<li>过滤，过滤阶段会将所有满足 Pod 调度需求的节点选出来。</li>
<li>打分，打分阶段，调度器会为 Pod 从所有可调度节点中选取一个最合适的节点。 根据当前启用的打分规则，调度器会给每一个可调度节点进行打分。最后，kube-scheduler 会将 Pod 调度到得分最高的节点上。 如果存在多个得分最高的节点，kube-scheduler 会从中随机选取一个。</li>
</ul>
<h3 id="9-2-控制-k8s-调度"><a href="#9-2-控制-k8s-调度" class="headerlink" title="9.2 控制 k8s 调度"></a>9.2 控制 k8s 调度</h3><p>一般情况下 Pods 会部署在哪些 node 上，我们并不需要去关心和控制，kube-scheduler 会自动进行合理的调度。但是有时候，我们想去控制 pods 调度部署到指定的 node 节点上时，可以通过 nodeSelector 选择或者亲和性和反亲和性的配置去控制 pods 的调度。<strong>注意 nodeselector 和亲和性都是通过标签匹配的</strong>。</p>
<h4 id="9-2-1-nodeSelector-节点选择"><a href="#9-2-1-nodeSelector-节点选择" class="headerlink" title="9.2.1 nodeSelector 节点选择"></a>9.2.1 nodeSelector 节点选择</h4><p>在 Pods 资源配置文件，通过 nodeSelector 选择带有指定标签的节点，k8s 会将 Pod 调度到特定节点或节点组上，nodeSelector 节点选择器是限制 k8s 调度最简单的一种方式。</p>
<h4 id="9-2-1-nodeAffinity-节点亲和性"><a href="#9-2-1-nodeAffinity-节点亲和性" class="headerlink" title="9.2.1  nodeAffinity 节点亲和性"></a>9.2.1  nodeAffinity 节点亲和性</h4><p>nodeselector 是一种比较简单的控制 k8s 调度的方式，如果想控制粒度更细致的话，则需要用到 nodeAffinity(节点亲和性)定义策略去控制。亲和性的调度可以分成软策略和硬策略两种方式，如下：</p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution 硬策略，表示只会将 pods 调度到满足策略的节点上，如果没有满足策略的节点，将会一直重试匹配策略直到有满足策略的节点出现才调度部署 pods。 </li>
<li>preferredDuringSchedulingIgnoredDuringExecution 软策略，表示会优先将 pods 调度到满足策略的节点上，如果没有满足策略的节点，k8s 也会自动调度到不满足策略的节点上。</li>
</ul>
<p>labels 标签在 K8s 中是一个很重要的概念，k8s 资源之间的关联都是通过 label 来实现的如 Service、Deployment、Pods 之间的关联。节点亲和性控制 pods 的调度也是通过匹配 node 节点标签来实现，亲和性匹配 labels 语法支持的运算符有：In、NotIn、Exists、DoesNotExist、Gt、Lt。 </p>
<p>nodeAffinity 节点亲和性使用例子如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-node-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="comment"># 支持多个匹配表达式(matchExpressions)，表达式之间属于 or 的关系</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">          <span class="comment"># 支持匹配多个 key，多个 key 的匹配规则是 and 的关系</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="comment"># 匹配标签 key 等于 topology.kubernetes.io/zone 且标签值等于 antarctica-east1 或 antarctica-west1 的节点</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">topology.kubernetes.io/zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">antarctica-east1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">antarctica-west1</span></span><br><span class="line">            <span class="comment"># 匹配标签 key 等于 node.kubernetes.io/host 且标签值等于 192.168.204.3 或 192.168.204.4 的节点</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node.kubernetes.io/host</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.204</span><span class="number">.3</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.204</span><span class="number">.4</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node.kubernetes.io/disk</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ssd</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">another-node-label-key</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">another-node-label-value</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure>

<p><strong>注意多条件匹配规则如下</strong>：</p>
<ul>
<li>如果你同时指定了 nodeSelector 和 nodeAffinity，两者 必须都要满足， 才能将 Pod 调度到候选节点上。</li>
<li>如果你在与 nodeAffinity 类型关联的 nodeSelectorTerms 中指定多个条件， 只要其中一个 nodeSelectorTerms 满足（各个条件按逻辑或操作组合）的话，Pod 就可以被调度到节点上。</li>
<li>如果你在与 nodeSelectorTerms 中的条件相关联的单个 matchExpressions 字段中指定多个表达式， 则只有当所有表达式都满足（各表达式按逻辑与操作组合）时，Pod 才能被调度到节点上。</li>
</ul>
<h4 id="9-2-2-Pod-间亲和性与反亲和性"><a href="#9-2-2-Pod-间亲和性与反亲和性" class="headerlink" title="9.2.2 Pod 间亲和性与反亲和性"></a>9.2.2 Pod 间亲和性与反亲和性</h4><p>Pod 间亲和性与反亲和性与 Node 节点的亲和性类似，也有两种策略类型，不同的是 requiredDuringSchedulingIgnoredDuringExecution 用来设置亲和性，preferredDuringSchedulingIgnoredDuringExecution 用来设置反亲和性。实际使用例子如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># pod 亲和性</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="comment"># 注意匹配该标签要匹配的是 Pods 的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">security</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">S1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">topology.kubernetes.io/zone</span></span><br><span class="line">    <span class="comment"># pod 反亲和性</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">security</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">S2</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">topology.kubernetes.io/zone</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure>

<h4 id="9-2-3-污点（taints）与容忍（tolerations）"><a href="#9-2-3-污点（taints）与容忍（tolerations）" class="headerlink" title="9.2.3 污点（taints）与容忍（tolerations）"></a>9.2.3 污点（taints）与容忍（tolerations）</h4><p>nodeSelector 或者 nodeAffinity(节点亲和性)都是想要将 Pods 调度到预期的节点上，taints(污点)则恰好与之相反，如果将一个 node 节点标记为 taints ，则 Pods 将不会调度到该 node 节点上，除非 Pods 标识为可以容忍污点。</p>
<ol>
<li>查看节点是否有污点(taints)标签<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果 node 节点 taints 属性不为 &lt;node&gt; 说明已经有污点标签</span></span><br><span class="line">kubectl describe node | grep -i taints</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">kubectl describe node k8s-node01 | grep -i taints</span><br></pre></td></tr></table></figure></li>
<li>将为节点打上污点<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为 k8s-node01 节点打上 key1=value1 标签节点，并驱逐 k8s-node01 节点上的 Pods 到其他 node 节点上，并且新的 Pods 如果未设置污点容忍，则无法调度到此节点。 </span></span><br><span class="line">kubectl taint nodes k8s-node01 key1=value1:NoExecute</span><br><span class="line"><span class="comment"># 为 k8s-node01 节点打上 key=value1 标签，不驱逐 k8s-node01 节点上的 Pods, 新的 Pods 如果未设置污点容忍，则无法调度到此节点。 </span></span><br><span class="line">kubectl taint nodes k8s-node01 key1=value1:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 node 节点是否已经打上污点标签</span></span><br><span class="line">kubectl describe node k8s-node01 | grep -i taints</span><br></pre></td></tr></table></figure></li>
<li>删除节点污点标签<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes k8s-node01 key1=value1:NoExecute-</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="10-Helm"><a href="#10-Helm" class="headerlink" title="10. Helm"></a>10. Helm</h2><p>Helm 是部署 Kubernetes 应用包管理工具，比如有多个应用服务，部署的时候如果不使用 Helm 则需要手动的一个个的编写 Pods, Deployment, Service 等资源文件，相当繁琐，并且版本更新的时候也繁琐。Helm 是使用 Chart 将 Pods, Deployment, Service 等资源的 yaml 文件作为一个整体管理，相当于 docker 去管理 image 一样，我们可以自己创建 Chart ，也可以从 Helm 仓库查找和使用别人配置好的 Chart。</p>
<h3 id="10-1-Helm-的三个重要概念"><a href="#10-1-Helm-的三个重要概念" class="headerlink" title="10.1 Helm 的三个重要概念"></a>10.1 Helm 的三个重要概念</h3><ul>
<li>Helm 是命令行工具</li>
<li>Chart 应用服务的资源的 yaml 配置文件集合</li>
<li>Release 是 Chart 的部署实体，运行部署使用命令<code>helm install</code></li>
</ul>
<h3 id="10-2-安装-Helm"><a href="#10-2-安装-Helm" class="headerlink" title="10.2 安装 Helm"></a>10.2 安装 Helm</h3><h4 id="10-2-1-离线安装包安装"><a href="#10-2-1-离线安装包安装" class="headerlink" title="10.2.1 离线安装包安装"></a>10.2.1 离线安装包安装</h4><ol>
<li>下载对应系统的安装 <code>https://github.com/helm/helm/releases</code> 这里下载的是 <code>linux-amd64.tar.gz</code></li>
<li>解压离线包 <code>tar -zxvf linux-amd64.tar.gz</code></li>
<li>将解压后的 helm 可执行文件复制到 <code>/usr/local/bin</code> 或者 <code>/usr/bin</code> 目录</li>
<li>验证是否安装成功 <code>helm help</code></li>
</ol>
<h3 id="10-3-Helm-Chart-常用命令"><a href="#10-3-Helm-Chart-常用命令" class="headerlink" title="10.3 Helm Chart 常用命令"></a>10.3 Helm Chart 常用命令</h3><h2 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h2><ol>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/</a></li>
</ol>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/wiki/Java%20%E7%9F%A5%E8%AF%86%E7%82%B9/Drools%E7%AC%94%E8%AE%B0/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    Drools 笔记
                
            </div>
        </a>
    
    
        <a href="/wiki/Linux/SSH%20%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E5%92%8C%E5%AF%86%E9%92%A5%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">SSH 密码登录和密钥配置说明</div>
        </a>
    
</nav>





    
    



</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            <br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a target="_blank" rel="noopener" href="https://github.com/vianlex/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>

    </div>
</body>
</html>